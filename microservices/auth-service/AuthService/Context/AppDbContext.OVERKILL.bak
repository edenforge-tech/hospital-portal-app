using AuthService.Models.Identity;
using AuthService.Models.Domain;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Http;
using System;

namespace AuthService.Context
{
    public class AppDbContext : IdentityDbContext<
        AppUser, 
        AppRole, 
        Guid, 
        AppUserClaim, 
        AppUserRole, 
        AppUserLogin, 
        AppRoleClaim, 
        AppUserToken>
    {
        private readonly IHttpContextAccessor _httpContextAccessor;

        public AppDbContext(
            DbContextOptions<AppDbContext> options,
            IHttpContextAccessor httpContextAccessor) : base(options)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        // Domain DbSets
        public DbSet<Tenant> Tenants { get; set; }
        public DbSet<Branch> Branches { get; set; }
        public DbSet<Permission> Permissions { get; set; }
        public DbSet<RolePermission> RolePermissions { get; set; }
        public DbSet<AuditLog> AuditLogs { get; set; }
        public DbSet<FailedLoginAttempt> FailedLoginAttempts { get; set; }
        public DbSet<UserAttribute> UserAttributes { get; set; }
        public DbSet<Patient> Patients { get; set; }
        public DbSet<ClinicalExamination> ClinicalExaminations { get; set; }
        public DbSet<Appointment> Appointments { get; set; }

        protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);

            // Configure Identity tables to use lowercase with underscores
            builder.Entity<AppUser>(entity =>
            {
                entity.ToTable("users");
                entity.Property(u => u.Id).HasColumnName("id");
                entity.Property(u => u.UserName).HasColumnName("user_name");
                entity.Property(u => u.NormalizedUserName).HasColumnName("normalized_user_name");
                entity.Property(u => u.Email).HasColumnName("Email");
                entity.Property(u => u.NormalizedEmail).HasColumnName("NormalizedEmail");
                entity.Property(u => u.EmailConfirmed).HasColumnName("EmailConfirmed");
                entity.Property(u => u.PasswordHash).HasColumnName("PasswordHash");
                entity.Property(u => u.SecurityStamp).HasColumnName("SecurityStamp");
                entity.Property(u => u.ConcurrencyStamp).HasColumnName("ConcurrencyStamp");
                entity.Property(u => u.PhoneNumber).HasColumnName("PhoneNumber");
                entity.Property(u => u.PhoneNumberConfirmed).HasColumnName("PhoneNumberConfirmed");
                entity.Property(u => u.TwoFactorEnabled).HasColumnName("TwoFactorEnabled");
                entity.Property(u => u.LockoutEnd).HasColumnName("LockoutEnd");
                entity.Property(u => u.LockoutEnabled).HasColumnName("LockoutEnabled");
                entity.Property(u => u.AccessFailedCount).HasColumnName("AccessFailedCount");
                
                // Custom properties
                entity.Property(u => u.TenantId).HasColumnName("tenant_id");
                entity.Property(u => u.FirstName).HasColumnName("first_name");
                entity.Property(u => u.LastName).HasColumnName("last_name");
                entity.Property(u => u.UserType).HasColumnName("user_type");
                entity.Property(u => u.UserStatus).HasColumnName("user_status");
                entity.Property(u => u.CreatedAt).HasColumnName("created_at");
                entity.Property(u => u.UpdatedAt).HasColumnName("updated_at");
                entity.Property(u => u.LastLoginAt).HasColumnName("last_login_at");
                
                // Ignore properties that don't have database columns
                entity.Ignore(u => u.DateOfBirth);
                entity.Ignore(u => u.Gender);
                entity.Ignore(u => u.Address);
                entity.Ignore(u => u.City);
                entity.Ignore(u => u.State);
                entity.Ignore(u => u.PostalCode);
                entity.Ignore(u => u.Country);
                entity.Ignore(u => u.ProfilePictureUrl);
                entity.Ignore(u => u.Bio);
                entity.Ignore(u => u.EmergencyContact);
                entity.Ignore(u => u.PreferredLanguage);
                entity.Ignore(u => u.Timezone);
                entity.Ignore(u => u.MfaEnabled);
                entity.Ignore(u => u.MfaSecret);
                entity.Ignore(u => u.BackupCodes);
                entity.Ignore(u => u.PreferredMfaMethod);
                entity.Ignore(u => u.PasswordExpiresAt);
                entity.Ignore(u => u.MustChangePassword);
                entity.Ignore(u => u.PasswordChangedAt);
                entity.Ignore(u => u.FailedLoginAttempts);
                entity.Ignore(u => u.AccountLockedUntil);
                entity.Ignore(u => u.IsEmailVerified);
                entity.Ignore(u => u.EmailVerificationToken);
                entity.Ignore(u => u.EmailVerificationExpiry);
                entity.Ignore(u => u.Designation);
                entity.Ignore(u => u.Specialization);
                entity.Ignore(u => u.Qualifications);
                entity.Ignore(u => u.LicenseNumber);
                entity.Ignore(u => u.YearsOfExperience);
                entity.Ignore(u => u.ConsultationFee);
                entity.Ignore(u => u.Availability);
                entity.Ignore(u => u.Department);
                entity.Ignore(u => u.ManagerId);
                entity.Ignore(u => u.HireDate);
                entity.Ignore(u => u.TerminationDate);
                entity.Ignore(u => u.Salary);
                
                // Add query filter for tenant isolation
                entity.HasQueryFilter(u => u.TenantId == GetCurrentTenantId());
            });

            builder.Entity<AppRole>(entity =>
            {
                entity.ToTable("roles");
                entity.Property(r => r.Id).HasColumnName("id");
                entity.Property(r => r.Name).HasColumnName("name");
                entity.Property(r => r.NormalizedName).HasColumnName("NormalizedName");
                entity.Property(r => r.ConcurrencyStamp).HasColumnName("ConcurrencyStamp");
                entity.Property(r => r.TenantId).HasColumnName("tenant_id");
                
                // Ignore properties that don't exist in database
                entity.Ignore(r => r.Description);
                entity.Ignore(r => r.IsSystemRole);
                entity.Ignore(r => r.IsActive);
                entity.Ignore(r => r.CreatedAt);
                entity.Ignore(r => r.UpdatedAt);
                entity.Ignore(r => r.CreatedBy);
                entity.Ignore(r => r.UpdatedBy);
                entity.Ignore(r => r.RoleLevel);
                entity.Ignore(r => r.ParentRoleId);
                entity.Ignore(r => r.MaxUsers);
                entity.Ignore(r => r.Priority);
                entity.Ignore(r => r.Color);
                entity.Ignore(r => r.Icon);
                entity.Ignore(r => r.DeletedAt);
                entity.Ignore(r => r.DeletedBy);
            });

            builder.Entity<AppUserRole>(entity =>
            {
                entity.ToTable("user_roles");
                entity.Property(ur => ur.UserId).HasColumnName("UserId");
                entity.Property(ur => ur.RoleId).HasColumnName("RoleId");
            });

            builder.Entity<AppRoleClaim>(entity =>
            {
                entity.ToTable("AspNetRoleClaims");
            });

            builder.Entity<AppUserClaim>(entity =>
            {
                entity.ToTable("AspNetUserClaims");
            });

            builder.Entity<AppUserLogin>(entity =>
            {
                entity.ToTable("AspNetUserLogins");
            });

            builder.Entity<AppUserToken>(entity =>
            {
                entity.ToTable("AspNetUserTokens");
            });

            // Configure Tenant entity - ONLY columns that exist in database
            builder.Entity<Tenant>(entity =>
            {
                entity.ToTable("tenant");
                entity.Property(t => t.Id).HasColumnName("id");
                entity.Property(t => t.Name).HasColumnName("name");
                entity.Property(t => t.Domain).HasColumnName("domain");
                entity.Property(t => t.Status).HasColumnName("status");
                entity.Property(t => t.TenantCode).HasColumnName("tenant_code");
                entity.Property(t => t.CreatedAt).HasColumnName("created_at");
                entity.Property(t => t.UpdatedAt).HasColumnName("updated_at");
                
                // Ignore computed property
                entity.Ignore(t => t.IsActive);
                
                // Ignore properties that don't exist in database
                entity.Ignore(t => t.RegistrationNumber);
                entity.Ignore(t => t.Email);
                entity.Ignore(t => t.Phone);
                entity.Ignore(t => t.Address);
                entity.Ignore(t => t.City);
                entity.Ignore(t => t.State);
                entity.Ignore(t => t.Pincode);
                entity.Ignore(t => t.Country);
                entity.Ignore(t => t.SubscriptionTier);
                entity.Ignore(t => t.MaxBranches);
                entity.Ignore(t => t.MaxUsers);
                entity.Ignore(t => t.CreatedBy);
                entity.Ignore(t => t.UpdatedBy);
            });

            // Configure other domain entities
            builder.Entity<Branch>(entity =>
            {
                entity.ToTable("branch");
                entity.HasQueryFilter(b => b.TenantId == GetCurrentTenantId());
            });

            builder.Entity<Permission>(entity =>
            {
                entity.ToTable("permissions");
            });

            builder.Entity<RolePermission>(entity =>
            {
                entity.ToTable("role_permissions");
            });

            builder.Entity<AuditLog>(entity =>
            {
                entity.ToTable("audit_logs");
                
                // Ignore alias properties
                entity.Ignore(a => a.Changes);
                entity.Ignore(a => a.EntityType);
                entity.Ignore(a => a.EntityId);
                entity.Ignore(a => a.UserName);
                entity.Ignore(a => a.Timestamp);
                entity.Ignore(a => a.Description);
            });

            builder.Entity<FailedLoginAttempt>(entity =>
            {
                entity.ToTable("failed_login_attempts");
            });

            builder.Entity<UserAttribute>(entity =>
            {
                entity.ToTable("user_attributes");
            });

            builder.Entity<Patient>(entity =>
            {
                entity.ToTable("patient");
                entity.HasQueryFilter(p => p.TenantId == GetCurrentTenantId());
            });

            builder.Entity<ClinicalExamination>(entity =>
            {
                entity.ToTable("clinical_examination");
                entity.HasQueryFilter(ce => ce.TenantId == GetCurrentTenantId());
            });

            builder.Entity<Appointment>(entity =>
            {
                entity.ToTable("appointment");
                entity.HasQueryFilter(a => a.TenantId == GetCurrentTenantId());
            });
        }

        // Helper method to get current tenant ID from HTTP context
        private Guid GetCurrentTenantId()
        {
            if (_httpContextAccessor?.HttpContext?.Items.TryGetValue("TenantId", out var tenantId) == true)
            {
                if (tenantId is Guid guid)
                {
                    return guid;
                }
            }
            return Guid.Empty;
        }
    }
}
