(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[819],{2200:function(e,t,s){Promise.resolve().then(s.bind(s,5538))},5538:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return o}});var r=s(5650),a=s(5830),n=s(9856),i=s(2317),l=s(9216);function o(){let{user:e}=(0,a.c_)();(0,n.useRouter)();let[t,s]=(0,i.useState)(null),[o,c]=(0,i.useState)(!0),[d,u]=(0,i.useState)(!1),[m,g]=(0,i.useState)(""),[h,p]=(0,i.useState)("all"),[x,f]=(0,i.useState)(""),[v,b]=(0,i.useState)(""),[y,w]=(0,i.useState)(new Set),[j,N]=(0,i.useState)(new Set);(0,i.useEffect)(()=>{e&&S()},[e]);let S=async()=>{try{var e;c(!0);let t=await l.J2.getAll(),r=(null===(e=t.data)||void 0===e?void 0:e.permissions)||[],a=await l.h0.getAllWithUserCount(),n=a.data||[],i=n.map(e=>l.h0.getRolePermissions(e.id).catch(()=>({data:[]}))),o=await Promise.all(i),d={};n.forEach((e,t)=>{var s;d[e.id]=(null===(s=o[t].data)||void 0===s?void 0:s.map(e=>e.id))||[]}),s({permissions:r,roles:n,assignments:d})}catch(e){console.error("Error loading permission matrix:",e),f("Failed to load permission matrix")}finally{c(!1)}},k=(e,r)=>{if(!t)return;let a={...t},n=a.assignments[e]||[];n.includes(r)?a.assignments[e]=n.filter(e=>e!==r):a.assignments[e]=[...n,r],s(a)},I=async()=>{if(t&&0!==y.size&&0!==j.size){u(!0);try{let e=[];for(let s of j){let r=t.assignments[s]||[],a=Array.from(y).filter(e=>!r.includes(e));a.length>0&&e.push({roleId:s,permissionIds:[...r,...a]})}for(let t of e)await l.h0.assignPermissions(t.roleId,t.permissionIds);b("Bulk assigned ".concat(y.size," permissions to ").concat(j.size," roles")),w(new Set),N(new Set),S(),setTimeout(()=>b(""),3e3)}catch(t){var e,s;f((null===(s=t.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.message)||"Failed to assign permissions")}finally{u(!1)}}},C=async()=>{if(t&&0!==y.size&&0!==j.size){u(!0);try{let e=[];for(let s of j){let r=t.assignments[s]||[],a=r.filter(e=>!y.has(e));e.push({roleId:s,permissionIds:a})}for(let t of e)await l.h0.assignPermissions(t.roleId,t.permissionIds);b("Bulk removed ".concat(y.size," permissions from ").concat(j.size," roles")),w(new Set),N(new Set),S(),setTimeout(()=>b(""),3e3)}catch(t){var e,s;f((null===(s=t.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.message)||"Failed to remove permissions")}finally{u(!1)}}},A=e=>{w(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},P=e=>{N(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},R=(null==t?void 0:t.permissions.filter(e=>{var t;return("all"===h||e.module===h)&&(e.name.toLowerCase().includes(m.toLowerCase())||(null===(t=e.description)||void 0===t?void 0:t.toLowerCase().includes(m.toLowerCase()))||e.code.toLowerCase().includes(m.toLowerCase()))}))||[],T=[...new Set((null==t?void 0:t.permissions.map(e=>e.module))||[])];return o||!e?(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),(0,r.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading permissions matrix..."})]})}):(0,r.jsx)("div",{className:"p-8",children:(0,r.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,r.jsxs)("div",{className:"mb-8 flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Permissions Management"}),(0,r.jsx)("p",{className:"text-gray-600 mt-2",children:"Manage permissions and bulk assignments across roles"})]}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("button",{onClick:I,disabled:d||0===y.size||0===j.size,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:d?"Assigning...":"Assign to ".concat(j.size," Roles")}),(0,r.jsx)("button",{onClick:C,disabled:d||0===y.size||0===j.size,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed",children:d?"Removing...":"Remove from ".concat(j.size," Roles")})]})]}),(0,r.jsxs)("div",{className:"mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-blue-900 mb-3",children:"Bulk Operations"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"font-medium text-blue-800 mb-2",children:["Permissions (",y.size," selected)"]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>{w(new Set(R.map(e=>e.id)))},className:"px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700",children:"Select All"}),(0,r.jsx)("button",{onClick:()=>{w(new Set)},className:"px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700",children:"Clear All"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"font-medium text-blue-800 mb-2",children:["Roles (",j.size," selected)"]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>{N(new Set((null==t?void 0:t.roles.map(e=>e.id))||[]))},className:"px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700",children:"Select All"}),(0,r.jsx)("button",{onClick:()=>{N(new Set)},className:"px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700",children:"Clear All"})]})]})]})]}),v&&(0,r.jsx)("div",{className:"mb-4 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg",children:v}),x&&(0,r.jsxs)("div",{className:"mb-4 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg",children:[x,(0,r.jsx)("button",{onClick:()=>f(""),className:"float-right font-bold",children:"\xd7"})]}),(0,r.jsxs)("div",{className:"mb-6 flex gap-4",children:[(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsx)("input",{type:"text",placeholder:"Search permissions...",value:m,onChange:e=>g(e.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"})}),(0,r.jsx)("div",{children:(0,r.jsxs)("select",{value:h,onChange:e=>p(e.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",children:[(0,r.jsx)("option",{value:"all",children:"All Modules"}),T.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]})})]}),(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full",children:[(0,r.jsx)("thead",{className:"bg-gray-50 border-b border-gray-200",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50",children:"Permission"}),null==t?void 0:t.roles.map(e=>(0,r.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]",children:(0,r.jsxs)("div",{className:"flex flex-col items-center gap-1",children:[(0,r.jsx)("input",{type:"checkbox",checked:j.has(e.id),onChange:()=>P(e.id),className:"h-3 w-3 text-blue-600 focus:ring-blue-500 border-gray-300 rounded",title:"Select role for bulk operation"}),(0,r.jsxs)("div",{className:"text-center",children:[e.name,(0,r.jsx)("br",{}),(0,r.jsxs)("span",{className:"text-xs text-gray-400",children:["(",e.userCount||0," users)"]})]})]})},e.id))]})}),(0,r.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:R.map(e=>(0,r.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,r.jsx)("td",{className:"px-6 py-4 sticky left-0 bg-white border-r border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("input",{type:"checkbox",checked:y.has(e.id),onChange:()=>A(e.id),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded",title:"Select for bulk operation"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),(0,r.jsx)("div",{className:"text-sm text-gray-500",children:e.code}),(0,r.jsxs)("div",{className:"text-xs text-gray-400 mt-1",children:[e.module," • ",e.resourceType," • ",e.action]}),e.description&&(0,r.jsx)("div",{className:"text-xs text-gray-600 mt-1",children:e.description})]})]})}),null==t?void 0:t.roles.map(s=>{let a=(t.assignments[s.id]||[]).includes(e.id);return(0,r.jsx)("td",{className:"px-6 py-4 text-center",children:(0,r.jsx)("input",{type:"checkbox",checked:a,onChange:()=>k(s.id,e.id),className:"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"})},s.id)})]},e.id))})]})}),0===R.length&&(0,r.jsxs)("div",{className:"text-center py-12",children:[(0,r.jsx)("div",{className:"text-6xl mb-4",children:"\uD83D\uDD10"}),(0,r.jsx)("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:"No Permissions Found"}),(0,r.jsx)("p",{className:"text-gray-600",children:m||"all"!==h?"Try adjusting your filters":"No permissions available"})]})]}),t&&(0,r.jsxs)("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Total Permissions"}),(0,r.jsx)("p",{className:"text-3xl font-bold text-indigo-600",children:t.permissions.length})]}),(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Total Roles"}),(0,r.jsx)("p",{className:"text-3xl font-bold text-green-600",children:t.roles.length})]})]})]})})}},9216:function(e,t,s){"use strict";let r;s.d(t,{Di:function(){return o},J2:function(){return g},WU:function(){return h},ac:function(){return l},g8:function(){return u},h0:function(){return m},h5:function(){return c},iJ:function(){return d},qN:function(){return i},sl:function(){return p}});var a=s(6470),n=s(3966);s(2189);let i=()=>((r=a.Z.create({baseURL:"http://localhost:5073/api",headers:{"Content-Type":"application/json"}})).interceptors.request.use(e=>{let{tenantId:t,token:s}=n.t.getState();return t&&(e.headers["X-Tenant-ID"]=t),s&&(e.headers.Authorization="Bearer ".concat(s)),e}),r.interceptors.response.use(e=>e,e=>{var t,s;return(null===(t=e.response)||void 0===t?void 0:t.status)===401?(n.t.getState().logout(),window.location.href="/auth/login"):(null===(s=e.response)||void 0===s?void 0:s.status)===403&&(window.location.href="/dashboard/unauthorized"),Promise.reject(e)}),r),l=()=>r||i(),o={getAll:()=>l().get("/patients"),getById:e=>l().get("/patients/".concat(e)),create:e=>l().post("/patients",e),update:(e,t)=>l().put("/patients/".concat(e),t),delete:e=>l().delete("/patients/".concat(e))},c={getAll:()=>l().get("/examinations"),getById:e=>l().get("/examinations/".concat(e)),getByPatient:e=>l().get("/examinations/patient/".concat(e)),create:e=>l().post("/examinations",e),update:(e,t)=>l().put("/examinations/".concat(e),t),delete:e=>l().delete("/examinations/".concat(e))},d={login:(e,t,s)=>l().post("/auth/login",{email:e,password:t,tenantId:s}),changePassword:(e,t)=>l().post("/auth/change-password",{currentPassword:e,newPassword:t})},u={getAll:()=>l().get("/users"),getAllWithDetails:()=>l().get("/users/with-details"),getById:e=>l().get("/users/".concat(e)),create:e=>l().post("/users",e),update:(e,t)=>l().put("/users/".concat(e),t),deactivate:e=>l().post("/users/".concat(e,"/deactivate"))},m={getAll:()=>l().get("/roles"),getAllWithUserCount:()=>l().get("/roles/with-user-count"),getById:e=>l().get("/roles/".concat(e)),create:e=>l().post("/roles",e),update:(e,t)=>l().put("/roles/".concat(e),t),delete:e=>l().delete("/roles/".concat(e)),assignRole:(e,t,s)=>l().post("/users/".concat(e,"/roles"),{roleId:t,branchId:s}),getRolePermissions:e=>l().get("/roles/".concat(e,"/permissions")),assignPermissions:(e,t)=>l().post("/roles/".concat(e,"/permissions"),{permissionIds:t}),removePermissions:(e,t)=>l().delete("/roles/".concat(e,"/permissions"),{data:{permissionIds:t}}),cloneRole:(e,t,s)=>l().post("/roles/".concat(e,"/clone"),{name:t,description:s})},g={getAll:()=>l().get("/permissions"),getAllGrouped:()=>l().get("/permissions/grouped"),getById:e=>l().get("/permissions/".concat(e)),create:e=>l().post("/permissions",e),update:(e,t)=>l().put("/permissions/".concat(e),t),delete:e=>l().delete("/permissions/".concat(e)),getByCategory:e=>l().get("/permissions/category/".concat(e)),bulkAssign:(e,t)=>l().post("/permissions/bulk-assign",{roleId:e,permissionIds:t}),bulkRemove:(e,t)=>l().delete("/permissions/bulk-remove",{data:{roleId:e,permissionIds:t}}),getMatrix:()=>l().get("/permissions/matrix"),getStatistics:()=>l().get("/permissions/statistics")},h={getAll:()=>l().get("/departments"),getAllWithStaffCount:()=>l().get("/departments/with-staff-count"),getById:e=>l().get("/departments/".concat(e))},p={getAll:()=>l().get("/branches")}},2189:function(e,t,s){"use strict";s.d(t,{f:function(){return a}});var r=s(9216);let a={assign:async function(e,t,s){let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return(0,r.ac)().post("/users/".concat(e,"/department-access"),{departmentId:t,accessLevel:s,isPrimary:a})},revoke:async(e,t)=>(0,r.ac)().delete("/users/".concat(e,"/department-access/").concat(t)),getUserDepartments:async e=>{let t=await (0,r.ac)().get("/users/".concat(e,"/department-access"));return t.data},getDepartmentUsers:async e=>(0,r.ac)().get("/departments/".concat(e,"/user-access")),updateAccessLevel:async(e,t,s)=>(0,r.ac)().put("/users/".concat(e,"/department-access/").concat(t),{accessLevel:s}),setPrimary:async(e,t)=>(0,r.ac)().put("/users/".concat(e,"/department-access/").concat(t),{isPrimary:!0}),bulkAssign:async e=>(0,r.ac)().post("/user-department-access/bulk-assign",{assignments:e}),getAccessMatrix:async e=>{let t=e?{departmentId:e}:{};return(0,r.ac)().get("/user-department-access/matrix",{params:t})}}},3966:function(e,t,s){"use strict";s.d(t,{R:function(){return n},t:function(){return a}});var r=s(9147);let a=(0,r.Ue)((e,t)=>({user:null,token:null,refreshToken:null,tenantId:null,roles:[],permissions:[],isLoading:!1,mustChangePassword:!1,setAuth:(t,s,r,a,n,i,l)=>{e({token:t,refreshToken:s,user:r,roles:a,permissions:n,tenantId:i,mustChangePassword:l}),localStorage.setItem("auth_token",t),localStorage.setItem("refresh_token",s),localStorage.setItem("user",JSON.stringify(r)),localStorage.setItem("roles",JSON.stringify(a)),localStorage.setItem("permissions",JSON.stringify(n)),localStorage.setItem("tenant_id",i)},logout:()=>{e({user:null,token:null,refreshToken:null,tenantId:null,roles:[],permissions:[],mustChangePassword:!1}),localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),localStorage.removeItem("roles"),localStorage.removeItem("permissions"),localStorage.removeItem("tenant_id")},clearMustChangePassword:()=>e({mustChangePassword:!1}),hasPermission:e=>{let{permissions:s}=t();return!!(s&&Array.isArray(s))&&(!!s.includes("*")||s.includes(e))},hasRole:e=>{let{roles:s}=t();return!!(s&&Array.isArray(s))&&s.includes(e)}}));function n(){try{let e=localStorage.getItem("auth_token"),t=localStorage.getItem("refresh_token"),s=localStorage.getItem("user"),r=localStorage.getItem("roles"),n=localStorage.getItem("permissions"),i=localStorage.getItem("tenant_id");if(e&&s){let l=JSON.parse(s),o=r?JSON.parse(r):[],c=n?JSON.parse(n):[];a.getState().setAuth(e,t||null,l,o,c,i||null,a.getState().mustChangePassword)}}catch(e){console.warn("Failed to hydrate auth from storage",e)}}},5830:function(e,t,s){"use strict";s.d(t,{c_:function(){return n}});var r=s(3966);let a=new class{get(e){let t=this.cache.get(e);return t?Date.now()>t.timestamp+t.ttl?(this.cache.delete(e),this.saveToStorage(),null):t:null}set(e,t,s){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a={permissions:[...t],roles:[...s],timestamp:Date.now(),ttl:r.ttl||this.defaultTTL};this.cache.set(e,a),this.saveToStorage()}invalidate(e){this.cache.delete(e),this.saveToStorage()}clear(){this.cache.clear(),this.saveToStorage()}hasPermission(e,t){let s=this.get(e);return s?!!s.permissions.includes("*")||s.permissions.includes(t):null}hasRole(e,t){let s=this.get(e);return s?s.roles.includes(t):null}getPermissions(e){let t=this.get(e);return t?[...t.permissions]:null}getRoles(e){let t=this.get(e);return t?[...t.roles]:null}saveToStorage(){try{let e=Object.fromEntries(this.cache);localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(e){console.warn("Failed to save permission cache to storage:",e)}}loadFromStorage(){try{let e=localStorage.getItem(this.storageKey);if(e){let t=JSON.parse(e);this.cache=new Map(Object.entries(t))}}catch(e){console.warn("Failed to load permission cache from storage:",e),this.cache.clear()}}startCleanupInterval(){setInterval(()=>{let e=Date.now(),t=!1;for(let[s,r]of this.cache.entries())e>r.timestamp+r.ttl&&(this.cache.delete(s),t=!0);t&&this.saveToStorage()},6e4)}constructor(){this.cache=new Map,this.defaultTTL=3e5,this.storageKey="permission_cache",this.loadFromStorage(),this.startCleanupInterval()}};function n(){let e=(0,r.t)();return{...e,hasPermission:t=>{let s=e.user;if(!s)return!1;let r=a.hasPermission(s.id,t);return null!==r?r:e.hasPermission(t)},hasRole:t=>{let s=e.user;if(!s)return!1;let r=a.hasRole(s.id,t);return null!==r?r:e.hasRole(t)},getPermissions:()=>{let t=e.user;if(!t)return[];let s=a.getPermissions(t.id);return null!==s?s:e.permissions||[]},getRoles:()=>{let t=e.user;if(!t)return[];let s=a.getRoles(t.id);return null!==s?s:e.roles||[]},setAuth:(t,s,r,n,i,l,o)=>{e.setAuth(t,s,r,n,i,l,o),a.set(r.id,i,n)},logout:()=>{let t=e.user;t&&a.invalidate(t.id),e.logout()}}}},9856:function(e,t,s){e.exports=s(39)}},function(e){e.O(0,[675,510,662,744],function(){return e(e.s=2200)}),_N_E=e.O()}]);